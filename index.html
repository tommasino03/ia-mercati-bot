
<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Segnali Mercati</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #0f172a;
  color: white;
  padding: 20px;
  margin: 0;
}

h1 {
  text-align: center;
  margin-bottom: 20px;
}

#aggiornamento {
  text-align: center;
  margin-bottom: 30px;
  font-size: 18px;
}

#container {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 20px;
}

.card {
  background: #1e293b;
  padding: 20px;
  border-radius: 15px;
  width: 240px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.5);
  transition: transform 0.2s;
}

.card:hover {
  transform: scale(1.05);
}

.card h2 {
  margin-top: 0;
  text-align: center;
}

.card p {
  margin: 5px 0;
  text-align: center;
  font-size: 16px;
}

.buy {
  color: #22c55e;
  font-weight: bold;
}

.wait {
  color: #facc15;
  font-weight: bold;
}
</style>

<!-- Chart.js per i grafici -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h1>ðŸ“Š Segnali Mercati</h1>
<p id="aggiornamento">Aggiornamento: --</p>

<div id="container"></div>
<script>
fetch('signals.json')
  .then(response => response.json())
  .then(data => {
    document.getElementById('aggiornamento').textContent = 
      "Aggiornamento: " + data.aggiornamento;

    const container = document.getElementById('container');

    data.segnali.forEach(item => {
      const card = document.createElement('div');
      card.className = 'card';

      let azioneClass = item.azione.toLowerCase() === 'compra' ? 'buy' : 'wait';

      const canvasId = 'chart-' + item.nome;
      card.innerHTML = `
        <h2>${item.nome}</h2>
        <p>Score: ${item.score}</p>
        <p class="${azioneClass}">Azione: ${item.azione}</p>
        <p>Importo: ${item.importo} â‚¬</p>
        <canvas id="${canvasId}" width="220" height="100"></canvas>
      `;

      container.appendChild(card);

      // Scarica dati storici da Yahoo Finance
      fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${item.nome}`)
        .then(r => r.json())
        .then(resp => {
          const timestamps = resp.chart.result[0].timestamp;
          const closes = resp.chart.result[0].indicators.quote[0].close;

          // Calcola medie mobili
          function movingAverage(arr, period) {
            let ma = [];
            for (let i = 0; i < arr.length; i++) {
              if (i < period-1) {
                ma.push(null);
              } else {
                let sum = 0;
                for (let j = i-period+1; j <= i; j++) sum += arr[j];
                ma.push(sum/period);
              }
            }
            return ma;
          }

          const ma20 = movingAverage(closes, 20);
          const ma50 = movingAverage(closes, 50);

          new Chart(document.getElementById(canvasId), {
            type: 'line',
            data: {
              labels: timestamps.map(t => new Date(t*1000).toLocaleDateString()),
              datasets: [
                {
                  label: 'Prezzo',
                  data: closes,
                  borderColor: 'rgba(34, 197, 94, 1)',
                  backgroundColor: 'rgba(34, 197, 94, 0.2)',
                  tension: 0.3
                },
                {
                  label: 'MA20',
                  data: ma20,
                  borderColor: 'rgba(59, 130, 246, 1)',
                  backgroundColor: 'rgba(59, 130, 246, 0.2)',
                  borderDash: [5,5],
                  tension: 0.3
                },
                {
                  label: 'MA50',
                  data: ma50,
                  borderColor: 'rgba(249, 115, 22, 1)',
                  backgroundColor: 'rgba(249, 115, 22, 0.2)',
                  borderDash: [5,5],
                  tension: 0.3
                }
              ]
            },
            options: {
              responsive: true,
              plugins: { legend: { display: true } },
              scales: { x: { display: false }, y: { beginAtZero: false } }
            }
          });
        })
        .catch(err => console.log("Errore grafico", item.nome));
    });
  })
  .catch(err => {
    document.getElementById('container').innerHTML = 
      '<p>Impossibile leggere signals.json</p>';
    console.error(err);
  });
</script>



</body>
</html>
